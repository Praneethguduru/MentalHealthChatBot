<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>MentalHealthChatBot</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600&family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet"/>
<style>
:root{--bg:#0d0d0f;--bg2:#141416;--bg3:#1c1c1f;--bg4:#242428;--bd:rgba(255,255,255,.07);--bd2:rgba(255,255,255,.13);--tx:#f0efe8;--tx2:#9998a0;--tx3:#5c5b63;--ac:#7c6aff;--ac2:#a78bfa;--gr:#34d399;--re:#f87171}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{font-family:'Sora',sans-serif;background:var(--bg);color:var(--tx);font-size:14px;line-height:1.6}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:4px}
#app{display:flex;height:100vh}
#sb{width:260px;flex-shrink:0;background:var(--bg2);border-right:1px solid var(--bd);display:flex;flex-direction:column}
.sh{padding:20px 16px 14px;border-bottom:1px solid var(--bd)}
.logo{font-family:'DM Serif Display',serif;font-size:21px;display:flex;align-items:center;gap:9px}
.lorb{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--ac),var(--ac2));display:flex;align-items:center;justify-content:center;font-size:14px;box-shadow:0 0 14px rgba(124,106,255,.45);flex-shrink:0}
.nbtn{margin-top:12px;width:100%;padding:9px 12px;background:var(--bg3);border:1px solid var(--bd2);border-radius:10px;color:var(--tx2);font-family:'Sora',sans-serif;font-size:13px;cursor:pointer;display:flex;align-items:center;gap:8px;transition:all .15s}
.nbtn:hover{background:var(--bg4);color:var(--tx);border-color:rgba(124,106,255,.4)}
.slbl{padding:14px 16px 5px;font-size:10px;font-weight:600;letter-spacing:1.2px;text-transform:uppercase;color:var(--tx3)}
#cl{flex:1;overflow-y:auto;padding:4px 8px}
.ci{display:flex;align-items:center;gap:6px;padding:8px 10px;border-radius:9px;cursor:pointer;transition:background .12s;margin-bottom:1px}
.ci:hover{background:var(--bg3)}.ci.active{background:var(--bg4)}
.cico{font-size:12px;opacity:.35;flex-shrink:0}
.cttl{flex:1;font-size:13px;color:var(--tx2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;transition:color .12s}
.ci:hover .cttl,.ci.active .cttl{color:var(--tx)}
.cac{display:none;gap:2px}.ci:hover .cac{display:flex}
.ib{background:none;border:none;color:var(--tx3);cursor:pointer;padding:3px 6px;border-radius:5px;font-size:12px;transition:all .12s}
.ib:hover{color:var(--tx);background:rgba(255,255,255,.06)}.ib.dl:hover{color:var(--re)}
.sf{padding:10px 8px;border-top:1px solid var(--bd);display:flex;flex-direction:column;gap:3px}
.fb{width:100%;padding:9px 12px;background:none;border:none;border-radius:9px;color:var(--tx2);font-family:'Sora',sans-serif;font-size:13px;cursor:pointer;display:flex;align-items:center;gap:9px;transition:all .12s;text-align:left}
.fb:hover{background:var(--bg3);color:var(--tx)}
.fic{width:22px;height:22px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0}
.fg{background:rgba(52,211,153,.15);color:var(--gr)}.fp{background:rgba(167,139,250,.15);color:var(--ac2)}
.fr{background:rgba(248,113,113,.1);color:var(--re)}
.logout-divider{height:1px;background:var(--bd);margin:4px 8px}
.fblogout{color:var(--re)!important}
.fblogout:hover{background:rgba(248,113,113,.08)!important}
#main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}
#auth{flex:1;display:flex;align-items:center;justify-content:center;padding:20px}
.ac{width:100%;max-width:380px;background:var(--bg2);border:1px solid var(--bd2);border-radius:20px;padding:38px 32px}
.alogo{display:flex;justify-content:center;margin-bottom:10px}
.aorb{width:48px;height:48px;border-radius:14px;background:linear-gradient(135deg,var(--ac),var(--ac2));display:flex;align-items:center;justify-content:center;font-size:22px;box-shadow:0 0 24px rgba(124,106,255,.45)}
.attl{font-family:'DM Serif Display',serif;font-size:28px;text-align:center;margin-bottom:6px}
.asub{text-align:center;color:var(--tx2);font-size:13px;margin-bottom:30px}
.lbl{display:block;font-size:12px;font-weight:500;color:var(--tx2);margin-bottom:6px}
.fld{width:100%;padding:11px 14px;background:var(--bg3);border:1px solid var(--bd);border-radius:10px;color:var(--tx);font-family:'Sora',sans-serif;font-size:14px;margin-bottom:14px;outline:none;transition:border-color .15s}
.fld:focus{border-color:var(--ac)}.fld::placeholder{color:var(--tx3)}
.btp{width:100%;padding:12px;background:var(--ac);border:none;border-radius:10px;color:#fff;font-family:'Sora',sans-serif;font-size:14px;font-weight:500;cursor:pointer;transition:all .15s;margin-bottom:10px}
.btp:hover{background:var(--ac2);transform:translateY(-1px)}.btp:disabled{opacity:.45;cursor:not-allowed;transform:none}
.bts{width:100%;padding:12px;background:var(--bg3);border:1px solid var(--bd2);border-radius:10px;color:var(--tx2);font-family:'Sora',sans-serif;font-size:14px;cursor:pointer;transition:all .15s}
.bts:hover{background:var(--bg4);color:var(--tx)}
.dvd{display:flex;align-items:center;gap:12px;margin:14px 0;color:var(--tx3);font-size:12px}
.dvd::before,.dvd::after{content:'';flex:1;height:1px;background:var(--bd)}
.err{background:rgba(248,113,113,.08);border:1px solid rgba(248,113,113,.22);color:var(--re);border-radius:8px;padding:10px 12px;font-size:13px;margin-bottom:14px}
#chat{flex:1;display:none;flex-direction:column;overflow:hidden}
.chdr{padding:13px 20px;border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;min-height:52px}
#ctitle{font-size:14px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:380px}
.ttsbtn{padding:6px 12px;background:var(--bg3);border:1px solid var(--bd);border-radius:8px;color:var(--tx2);font-family:'Sora',sans-serif;font-size:12px;cursor:pointer;transition:all .12s;white-space:nowrap;flex-shrink:0}
.ttsbtn:hover{border-color:var(--ac);color:var(--tx)}.ttsbtn.on{background:rgba(124,106,255,.1);border-color:var(--ac);color:var(--ac2)}
#msgs{flex:1;overflow-y:auto;padding:20px 0 8px;display:flex;flex-direction:column}
.empty{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;padding:40px 20px;text-align:center}
.eorb{width:64px;height:64px;border-radius:20px;background:linear-gradient(135deg,rgba(124,106,255,.18),rgba(167,139,250,.08));border:1px solid rgba(124,106,255,.2);display:flex;align-items:center;justify-content:center;font-size:28px;margin-bottom:6px}
.ettl{font-family:'DM Serif Display',serif;font-size:22px;color:var(--tx2)}
.esub{font-size:13px;color:var(--tx3);max-width:280px;line-height:1.6}
kbd{background:var(--bg4);padding:1px 7px;border-radius:4px;font-size:11px;border:1px solid var(--bd2);font-family:'Sora',sans-serif}
.mrow{display:flex;align-items:flex-start;padding:3px 20px;animation:mi .2s ease}
@keyframes mi{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.mrow.user{justify-content:flex-end}.mrow.assistant{justify-content:flex-start}
.av{width:28px;height:28px;border-radius:50%;flex-shrink:0;margin-top:2px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600}
.mrow.assistant .av{background:linear-gradient(135deg,var(--ac),var(--ac2));color:#fff;margin-right:10px}
.mrow.user .av{background:var(--bg4);color:var(--tx2);margin-left:10px}
.mc{max-width:66%;display:flex;flex-direction:column}.mrow.user .mc{align-items:flex-end}
.bbl{padding:11px 15px;border-radius:18px;font-size:14px;line-height:1.65;white-space:pre-wrap;word-break:break-word}
.mrow.user .bbl{background:var(--bg3);border:1px solid rgba(124,106,255,.18);border-bottom-right-radius:5px}
.mrow.assistant .bbl{background:transparent;padding-left:0;border-bottom-left-radius:5px}
.vtag{font-size:11px;color:var(--tx3);margin-top:3px}
.typr{display:flex;align-items:center;gap:10px;padding:4px 20px}
.tav{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--ac),var(--ac2));display:flex;align-items:center;justify-content:center;font-size:12px;color:#fff;font-weight:600;flex-shrink:0}
.dots{display:flex;gap:5px;align-items:center;padding:10px 0}
.dot{width:7px;height:7px;background:var(--tx3);border-radius:50%;animation:bo 1.2s infinite}
.dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
@keyframes bo{0%,60%,100%{transform:translateY(0);opacity:.4}30%{transform:translateY(-6px);opacity:1}}
.iarea{padding:10px 20px 18px;flex-shrink:0}
.ibox{background:var(--bg2);border:1px solid var(--bd2);border-radius:16px;overflow:hidden;transition:border-color .15s,box-shadow .15s}
.ibox:focus-within{border-color:rgba(124,106,255,.35)}.ibox.rec{border-color:var(--re)!important;box-shadow:0 0 0 3px rgba(248,113,113,.1)}
#msgin{width:100%;padding:13px 16px 4px;background:transparent;border:none;color:var(--tx);font-family:'Sora',sans-serif;font-size:14px;resize:none;outline:none;line-height:1.55;min-height:46px;max-height:150px;overflow-y:auto;display:block}
#msgin::placeholder{color:var(--tx3)}
.itb{display:flex;align-items:center;justify-content:space-between;padding:5px 8px 9px}
.tl{display:flex;gap:4px;align-items:center}.tr{display:flex;gap:6px;align-items:center}
.hint{font-size:11px;color:var(--tx3);padding:0 4px}
.mic{width:34px;height:34px;border-radius:9px;border:1px solid var(--bd);background:var(--bg3);color:var(--tx2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;transition:all .15s;user-select:none;flex-shrink:0}
.mic:hover{border-color:var(--ac);color:var(--ac2);background:rgba(124,106,255,.1)}
.mic.rec{background:rgba(248,113,113,.12);border-color:var(--re);color:var(--re);animation:mg 1.4s infinite}
.mic:disabled{opacity:.35;cursor:not-allowed}
@keyframes mg{0%,100%{box-shadow:0 0 0 0 rgba(248,113,113,.3)}50%{box-shadow:0 0 0 7px rgba(248,113,113,0)}}
.sendbtn{width:34px;height:34px;border-radius:9px;background:var(--ac);border:none;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;transition:all .15s}
.sendbtn:hover:not(:disabled){background:var(--ac2);transform:scale(1.06)}.sendbtn:disabled{opacity:.3;cursor:not-allowed;transform:none}
#stl{text-align:center;font-size:11.5px;color:var(--tx3);padding-top:5px;min-height:22px;transition:color .2s}
#stl.on{color:var(--ac2)}
#phq8{flex:1;display:none;overflow-y:auto;padding:32px 60px 40px}
.ptl{font-family:'DM Serif Display',serif;font-size:28px;margin-bottom:6px}
.psub{color:var(--tx2);font-size:13px;font-style:italic;margin-bottom:28px}
.qcard{background:var(--bg2);border:1px solid var(--bd);border-radius:12px;padding:18px 20px;margin-bottom:10px;transition:border-color .15s}
.qcard.ans{border-color:rgba(124,106,255,.3)}
.qnum{font-size:11px;font-weight:600;letter-spacing:.8px;color:var(--tx3);text-transform:uppercase;margin-bottom:4px}
.qtxt{font-size:14px;font-weight:500;margin-bottom:14px}
.qopts{display:flex;flex-wrap:wrap;gap:8px}
.qopt{padding:7px 15px;background:var(--bg3);border:1px solid var(--bd);border-radius:8px;color:var(--tx2);font-family:'Sora',sans-serif;font-size:12px;cursor:pointer;transition:all .12s;user-select:none}
.qopt:hover{border-color:var(--ac);color:var(--tx)}.qopt.sel{background:rgba(124,106,255,.14);border-color:var(--ac);color:var(--ac2);font-weight:500}
.qacts{display:flex;gap:10px;margin-top:24px}
.bsub{padding:12px 30px;background:var(--ac);border:none;border-radius:10px;color:#fff;font-family:'Sora',sans-serif;font-size:14px;font-weight:500;cursor:pointer;transition:all .15s}
.bsub:hover:not(:disabled){background:var(--ac2)}.bsub:disabled{opacity:.4;cursor:not-allowed}
.bout{padding:12px 24px;background:var(--bg3);border:1px solid var(--bd2);border-radius:10px;color:var(--tx2);font-family:'Sora',sans-serif;font-size:14px;cursor:pointer;transition:all .12s}
.bout:hover{background:var(--bg4);color:var(--tx)}
#hist{flex:1;display:none;overflow-y:auto;padding:32px 60px 40px}
.hitem{background:var(--bg2);border:1px solid var(--bd);border-radius:12px;padding:16px 20px;margin-bottom:10px;display:flex;align-items:center;gap:16px}
.hsco{font-family:'DM Serif Display',serif;font-size:30px;line-height:1;min-width:52px;text-align:center}
.hof{font-size:11px;color:var(--tx3);text-align:center}
.hsev{font-size:14px;font-weight:500}.hdt{font-size:12px;color:var(--tx3);margin-top:3px}
.sdot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.mbg{position:fixed;inset:0;background:rgba(0,0,0,.58);backdrop-filter:blur(6px);z-index:5000;display:flex;align-items:center;justify-content:center}
.mbox{background:var(--bg2);border:1px solid var(--bd2);border-radius:18px;padding:28px;width:100%;max-width:370px;animation:pop .2s ease}
@keyframes pop{from{opacity:0;transform:scale(.93)}to{opacity:1;transform:scale(1)}}
.mttl{font-family:'DM Serif Display',serif;font-size:20px;margin-bottom:8px}
.mbdy{color:var(--tx2);font-size:13px;margin-bottom:4px}
.macts{display:flex;gap:10px;margin-top:18px}.macts button{flex:1}
.bdng{padding:11px;background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.35);border-radius:9px;color:var(--re);font-family:'Sora',sans-serif;font-size:13px;cursor:pointer;transition:all .12s}
.bdng:hover{background:rgba(248,113,113,.22)}
.bgh{padding:11px;background:var(--bg3);border:1px solid var(--bd);border-radius:9px;color:var(--tx2);font-family:'Sora',sans-serif;font-size:13px;cursor:pointer;transition:all .12s}
.bgh:hover{background:var(--bg4);color:var(--tx)}
#toast{display:none;position:fixed;top:18px;left:50%;transform:translateX(-50%);z-index:9500;background:var(--bg2);border:1px solid var(--bd2);border-radius:16px;padding:22px 32px;text-align:center;box-shadow:0 12px 52px rgba(0,0,0,.55);min-width:270px;animation:tda .3s ease}
@keyframes tda{from{opacity:0;transform:translateX(-50%) translateY(-14px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.tsc{font-family:'DM Serif Display',serif;font-size:48px;line-height:1;margin-bottom:4px}
.tsv{font-size:15px;font-weight:500;margin-bottom:4px}.tsb{font-size:12px;color:var(--tx2);line-height:1.5}
.tclose{margin-top:14px;padding:8px 22px;background:var(--bg3);border:1px solid var(--bd2);border-radius:8px;color:var(--tx2);font-family:'Sora',sans-serif;font-size:12px;cursor:pointer;transition:all .12s}
.tclose:hover{background:var(--bg4);color:var(--tx)}
#vbadge{display:none;position:fixed;bottom:22px;right:22px;padding:13px 16px;border-radius:14px;color:#fff;font-size:13px;line-height:1.75;font-weight:500;box-shadow:0 8px 36px rgba(0,0,0,.45);z-index:8000;min-width:200px;cursor:pointer;animation:bua .3s ease}
@keyframes bua{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.bx{float:right;margin-left:10px;opacity:.7;font-size:15px;line-height:1}
#vov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);backdrop-filter:blur(18px);z-index:9000;flex-direction:column;align-items:center;justify-content:center;animation:fi .2s ease}
@keyframes fi{from{opacity:0}to{opacity:1}}
#vov.show{display:flex}
.volbl{font-family:'DM Serif Display',serif;font-size:28px;color:var(--tx);margin-bottom:52px;opacity:.88}
.vowrap{position:relative;width:180px;height:180px;display:flex;align-items:center;justify-content:center;margin-bottom:50px}
.voring{position:absolute;border-radius:50%;border:1.5px solid rgba(124,106,255,.22);animation:rng 2s ease-out infinite}
.voring:nth-child(1){width:180px;height:180px;animation-delay:0s}
.voring:nth-child(2){width:142px;height:142px;animation-delay:.45s}
.voring:nth-child(3){width:108px;height:108px;animation-delay:.9s}
@keyframes rng{0%{transform:scale(.8);opacity:.85}100%{transform:scale(1.38);opacity:0}}
.voorb{position:relative;z-index:2;width:86px;height:86px;border-radius:50%;background:radial-gradient(circle at 35% 32%,#b8aaff,#7c6aff,#4338ca);box-shadow:0 0 30px rgba(124,106,255,.75),0 0 70px rgba(124,106,255,.35),inset 0 1px 2px rgba(255,255,255,.22);animation:ob 1.6s ease-in-out infinite;display:flex;align-items:center;justify-content:center}
@keyframes ob{0%,100%{transform:scale(1);box-shadow:0 0 30px rgba(124,106,255,.75),0 0 70px rgba(124,106,255,.35)}50%{transform:scale(1.12);box-shadow:0 0 50px rgba(124,106,255,.9),0 0 100px rgba(124,106,255,.45)}}
.vobars{display:flex;gap:3.5px;align-items:center}
.vobar{width:3px;background:rgba(255,255,255,.9);border-radius:2px;animation:vb .75s ease-in-out infinite}
.vobar:nth-child(1){height:9px;animation-delay:0s}.vobar:nth-child(2){height:21px;animation-delay:.1s}
.vobar:nth-child(3){height:30px;animation-delay:.2s}.vobar:nth-child(4){height:21px;animation-delay:.3s}
.vobar:nth-child(5){height:9px;animation-delay:.4s}
@keyframes vb{0%,100%{transform:scaleY(.42);opacity:.65}50%{transform:scaleY(1.3);opacity:1}}
.voht{font-size:13px;color:var(--tx2);margin-bottom:36px;font-style:italic;max-width:460px;text-align:center;padding:0 20px}
.vostop{padding:13px 40px;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.13);border-radius:50px;color:var(--tx2);font-family:'Sora',sans-serif;font-size:14px;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:8px}
.vostop:hover{background:rgba(255,255,255,.12);color:var(--tx)}
.voft{position:absolute;bottom:30px;font-size:12px;color:var(--tx3)}

/* PHQ-8 pending indicator */
.pending-msg{display:flex;align-items:center;gap:10px;padding:4px 20px;color:var(--tx3);font-size:12px;font-style:italic;animation:pf 1.5s ease-in-out infinite}
@keyframes pf{0%,100%{opacity:.4}50%{opacity:1}}
</style>
</head>
<body>
<div id="app">
  <div id="sb">
    <div class="sh">
      <div class="logo"><div class="lorb">üß†</div>MentalHealthChatBot</div>
      <button class="nbtn" onclick="newConv()"><span style="font-size:17px;opacity:.6">Ôºã</span> New conversation</button>
    </div>
    <p class="slbl">Conversations</p>
    <div id="cl"></div>
    <div class="sf">
      <button class="fb" onclick="showPHQ8()"><span class="fic fg">üìã</span> PHQ-8 Assessment</button>
      <button class="fb" onclick="showHist()"><span class="fic fp">üìà</span> Assessment History</button>
      <div class="logout-divider"></div>
      <button class="fb fblogout" onclick="doLogout()"><span class="fic fr">üö™</span> Log Out</button>
    </div>
  </div>
  <div id="main">
    <div id="auth">
      <div class="ac">
        <div class="alogo"><div class="aorb">üß†</div></div>
        <h1 class="attl">MentalHealthChatBot</h1>
        <p class="asub" id="asub">Sign in to continue</p>
        <div id="aerr" class="err" style="display:none"></div>
        <label class="lbl">Email</label>
        <input class="fld" id="ein" type="email" placeholder="you@example.com" onkeydown="if(event.key==='Enter')doAuth()"/>
        <label class="lbl">Password</label>
        <input class="fld" id="pin" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doAuth()"/>
        <button class="btp" id="abtn" onclick="doAuth()">Sign In</button>
        <div class="dvd">or</div>
        <button class="bts" id="atog" onclick="togAuth()">Create account</button>
      </div>
    </div>
    <div id="chat">
      <div class="chdr">
        <span id="ctitle">New Conversation</span>
        <button class="ttsbtn on" id="ttsbtn" onclick="togTTS()">üîä Voice ON</button>
      </div>
      <div id="msgs"></div>
      <div class="iarea">
        <div class="ibox" id="ibox">
          <textarea id="msgin" placeholder="Message MentalHealthChatBot‚Ä¶" rows="1" oninput="rsz(this)" onkeydown="kd(event)"></textarea>
          <div class="itb">
            <div class="tl"><span class="hint">Hold <kbd>Space</kbd> to speak</span></div>
            <div class="tr">
              <button class="mic" id="micbtn" onclick="togMic()" title="Click to speak">üéô</button>
              <button class="sendbtn" id="sndbtn" onclick="doSend()" title="Send">‚Üë</button>
            </div>
          </div>
        </div>
        <p id="stl"> </p>
      </div>
    </div>
    <div id="phq8">
      <div class="ptl">PHQ-8 Assessment</div>
      <p class="psub" id="pinst"></p>
      <div id="pqs"></div>
      <div class="qacts">
        <button class="bsub" id="psbtn" onclick="subPHQ()" disabled>Submit Assessment</button>
        <button class="bout" onclick="showChat()">Cancel</button>
      </div>
    </div>
    <div id="hist">
      <div class="ptl">Assessment History</div>
      <p class="psub" style="margin-bottom:20px">Your PHQ-8 scores over time</p>
      <div id="hlist"></div>
      <div style="margin-top:24px"><button class="bout" onclick="showChat()">‚Üê Back to Chat</button></div>
    </div>
  </div>
</div>

<div id="toast">
  <div class="tsc" id="tsc"></div>
  <div class="tsv" id="tsv"></div>
  <div class="tsb" id="tsb"></div>
  <div class="tsb" style="margin-top:6px">Switching to your conversation now‚Ä¶</div>
  <button class="tclose" onclick="closeTst()">Continue ‚Üí</button>
</div>

<div id="vbadge" onclick="this.style.display='none'">
  <span class="bx">‚úï</span><div id="vbc"></div>
</div>

<div id="vov">
  <p class="volbl">Listening‚Ä¶</p>
  <div class="vowrap">
    <div class="voring"></div><div class="voring"></div><div class="voring"></div>
    <div class="voorb">
      <div class="vobars">
        <div class="vobar"></div><div class="vobar"></div><div class="vobar"></div><div class="vobar"></div><div class="vobar"></div>
      </div>
    </div>
  </div>
  <p class="voht" id="liveTxt">Speak now ‚Äî listening for your voice‚Ä¶</p>
  <button class="vostop" onclick="stopVoice()">‚¨õ Click or press Space to stop</button>
  <p class="voft">Browser Speech Recognition (instant)</p>
</div>

<div id="renmdl" class="mbg" style="display:none" onclick="closeMdl('renmdl')">
  <div class="mbox" onclick="event.stopPropagation()">
    <h3 class="mttl">Rename Conversation</h3>
    <p class="mbdy">Enter a new title.</p>
    <input class="fld" id="renin" style="margin-top:8px" onkeydown="if(event.key==='Enter')doRen()"/>
    <div class="macts">
      <button class="btp" style="margin-bottom:0" onclick="doRen()">Save</button>
      <button class="bgh" onclick="closeMdl('renmdl')">Cancel</button>
    </div>
  </div>
</div>

<div id="delmdl" class="mbg" style="display:none" onclick="closeMdl('delmdl')">
  <div class="mbox" onclick="event.stopPropagation()">
    <h3 class="mttl">Delete Conversation?</h3>
    <p class="mbdy" id="delbdy">This cannot be undone.</p>
    <div class="macts">
      <button class="bdng" onclick="doDel()">Delete</button>
      <button class="bgh" onclick="closeMdl('delmdl')">Cancel</button>
    </div>
  </div>
</div>

<script>
const BASE='http://127.0.0.1:8000';
let tok=localStorage.getItem('ms_tok')||null,convs=[],cur=null,phqD=null,phqR={};
let ttsOn=true,busy=false,am='login',renT=null,delT=null,ttmr=null;
let recog=null,listening=false,finalTranscript='',interimTranscript='',spHeld=false;
let audioStream=null,mediaRecorder=null,audioChunks=[];
let recogEndedResolve=null;  // resolves when recognition truly finishes

// ‚îÄ‚îÄ PHQ-8 background polling ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let phqPollTimer=null;
let phqPollConvId=null;
let phqPollMsgCount=0;   // number of messages when polling started

async function api(m,p,b=null,auth=true){
  const h={'Content-Type':'application/json'};
  if(auth&&tok)h['Authorization']='Bearer '+tok;
  const r=await fetch(BASE+p,{method:m,headers:h,body:b?JSON.stringify(b):undefined});
  if(!r.ok){const e=await r.json().catch(()=>({detail:'Failed'}));throw new Error(e.detail||'Failed');}
  return r.json();
}

window.onload=()=>{tok?loadConvs():show('auth');initRecog();setupSpc();};

function show(id){
  ['auth','chat','phq8','hist'].forEach(s=>document.getElementById(s).style.display='none');
  const el=document.getElementById(id);
  el.style.display=id==='chat'?'flex':'block';
}
function showChat(){show('chat');}

// AUTH
function togAuth(){am=am==='login'?'signup':'login';document.getElementById('asub').textContent=am==='login'?'Sign in to continue':'Create your account';document.getElementById('abtn').textContent=am==='login'?'Sign In':'Create Account';document.getElementById('atog').textContent=am==='login'?'Create account':'Back to sign in';setErr('');}
function setErr(m){const e=document.getElementById('aerr');if(m){e.textContent=m;e.style.display='block';}else e.style.display='none';}
async function doAuth(){
  const em=document.getElementById('ein').value.trim(),pw=document.getElementById('pin').value;
  if(!em||!pw){setErr('Please fill both fields');return;}
  const btn=document.getElementById('abtn');btn.disabled=true;btn.textContent='‚Ä¶';setErr('');
  try{
    if(am==='login'){const d=await api('POST','/login',{email:em,password:pw},false);tok=d.access_token;localStorage.setItem('ms_tok',tok);await loadConvs();}
    else{await api('POST','/signup',{email:em,password:pw},false);alert('Account created ‚Äî please sign in.');togAuth();}
  }catch(e){setErr(e.message);}
  finally{btn.disabled=false;btn.textContent=am==='login'?'Sign In':'Create Account';}
}

// CONVS
function doLogout(){
  if(!confirm('Are you sure you want to log out?'))return;
  // Clear session
  tok=null;
  localStorage.removeItem('ms_tok');
  convs=[];cur=null;
  // Stop any active voice session
  if(listening)stopVoice();
  // Stop TTS
  window.speechSynthesis.cancel();
  // Stop any PHQ-8 polling
  stopPhqPoll();
  // Reset auth form
  document.getElementById('ein').value='';
  document.getElementById('pin').value='';
  setErr('');
  am='login';
  document.getElementById('asub').textContent='Sign in to continue';
  document.getElementById('abtn').textContent='Sign In';
  document.getElementById('atog').textContent='Create account';
  show('auth');
}

async function loadConvs(){
  try{const d=await api('GET','/conversations');convs=d.map(c=>({id:c.id,title:c.title||'New Conversation'}));renderSB();if(convs.length>0)selConv(convs[0]);else await newConv();}
  catch(e){if(e.message.includes('401')){localStorage.removeItem('ms_tok');tok=null;show('auth');}}
}
function renderSB(){
  const l=document.getElementById('cl');l.innerHTML='';
  if(!convs.length){l.innerHTML='<p style="font-size:12px;color:var(--tx3);padding:8px 12px">No conversations yet</p>';return;}
  convs.forEach(c=>{
    const d=document.createElement('div');d.className='ci'+(cur&&cur.id===c.id?' active':'');
    d.innerHTML=`<span class="cico">üí¨</span><span class="cttl">${esc(c.title)}</span><div class="cac"><button class="ib" onclick="openRen(event,${c.id})">‚úèÔ∏è</button><button class="ib dl" onclick="openDel(event,${c.id})">üóë</button></div>`;
    d.onclick=e=>{if(e.target.closest('.cac'))return;selConv(c);};
    l.appendChild(d);
  });
}
function selConv(c){cur=c;document.getElementById('ctitle').textContent=c.title;renderSB();loadMsgs(c.id);show('chat');}
async function newConv(){
  try{const d=await api('POST','/conversations');const c={id:d.conversation_id,title:'New Conversation'};convs.unshift(c);selConv(c);}
  catch(e){alert('Could not create conversation');}
}
async function loadMsgs(id){
  clrMsgs();
  try{const ms=await api('GET',`/conversations/${id}/messages`);if(!ms.length){showEmpty();return;}ms.forEach(m=>addMsg(m.role,m.content,false));}
  catch{showEmpty();}
  scrlB();
}
function openRen(e,id){e.stopPropagation();renT=convs.find(c=>c.id===id);document.getElementById('renin').value=renT.title;document.getElementById('renmdl').style.display='flex';setTimeout(()=>document.getElementById('renin').focus(),50);}
async function doRen(){const t=document.getElementById('renin').value.trim();if(!t)return;try{await api('PUT',`/conversations/${renT.id}/title`,{title:t});renT.title=t;if(cur?.id===renT.id){cur.title=t;document.getElementById('ctitle').textContent=t;}renderSB();closeMdl('renmdl');}catch(e){alert(e.message);}}
function openDel(e,id){e.stopPropagation();delT=convs.find(c=>c.id===id);document.getElementById('delbdy').innerHTML=`"<strong>${esc(delT.title)}</strong>" will be permanently deleted.`;document.getElementById('delmdl').style.display='flex';}
async function doDel(){try{await api('DELETE',`/conversations/${delT.id}`);convs=convs.filter(c=>c.id!==delT.id);if(cur?.id===delT.id){cur=null;if(convs.length>0)selConv(convs[0]);else await newConv();}renderSB();closeMdl('delmdl');}catch(e){alert(e.message);}}
function closeMdl(id){document.getElementById(id).style.display='none';}

// MESSAGES
function clrMsgs(){document.getElementById('msgs').innerHTML='';}
function showEmpty(){document.getElementById('msgs').innerHTML=`<div class="empty"><div class="eorb">üß†</div><p class="ettl">How are you feeling today?</p><p class="esub">Type a message or hold <kbd>Space</kbd> to speak.<br>Voice is transcribed instantly.</p></div>`;}
function addMsg(role,text,voice){
  const box=document.getElementById('msgs');
  box.querySelector('.empty')?.remove();
  const row=document.createElement('div');row.className='mrow '+role;
  const vt=voice?'<div class="vtag">üéô Voice</div>':'';
  if(role==='user')row.innerHTML=`<div class="mc" style="align-items:flex-end"><div class="bbl">${esc(text)}</div>${vt}</div><div class="av">U</div>`;
  else row.innerHTML=`<div class="av">M</div><div class="mc"><div class="bbl">${esc(text)}</div>${vt}</div>`;
  box.appendChild(row);scrlB();
}
function showTyp(){const b=document.getElementById('msgs');const r=document.createElement('div');r.className='typr';r.id='trow';r.innerHTML=`<div class="tav">M</div><div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`;b.appendChild(r);scrlB();}
function hideTyp(){document.getElementById('trow')?.remove();}

// Show a pulsing "Personalising response‚Ä¶" line after PHQ-8 submission
function showPending(){
  const b=document.getElementById('msgs');
  if(document.getElementById('pendrow'))return;
  const r=document.createElement('div');r.id='pendrow';r.className='pending-msg';
  r.innerHTML='<div class="tav" style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--ac),var(--ac2));display:flex;align-items:center;justify-content:center;font-size:12px;color:#fff;font-weight:600;flex-shrink:0">M</div><span>Personalising your response‚Ä¶</span>';
  b.appendChild(r);scrlB();
}
function hidePending(){document.getElementById('pendrow')?.remove();}

function scrlB(){const b=document.getElementById('msgs');setTimeout(()=>b.scrollTop=b.scrollHeight,50);}

// SEND TEXT
function rsz(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,150)+'px';}
function kd(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();doSend();}}
async function doSend(){
  if(!tok||!cur||busy)return;
  const inp=document.getElementById('msgin'),msg=inp.value.trim();if(!msg)return;
  inp.value='';rsz(inp);setBusy(true);addMsg('user',msg,false);showTyp();
  try{const d=await api('POST',`/chat/${cur.id}`,{message:msg});hideTyp();addMsg('assistant',d.response,false);speak(d.response);}
  catch(e){hideTyp();addMsg('assistant','‚ö†Ô∏è '+e.message,false);}
  finally{setBusy(false);}
}

// ‚îÄ‚îÄ VOICE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// KEY FIX: The "no speech detected" bug was a race condition.
// When recog.stop() is called, any INTERIM (non-final) words in progress
// were dropped before onresult could finalize them.
// Fix: we now save interim text too, wait for recog.onend to confirm
// recognition truly stopped, then merge final+interim as the transcript.
function initRecog(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){console.warn('Speech Recognition not supported');return;}
  recog=new SR();
  recog.continuous=true;
  recog.interimResults=true;
  recog.lang='en-US';

  recog.onresult=e=>{
    interimTranscript='';
    for(let i=e.resultIndex;i<e.results.length;i++){
      const t=e.results[i][0].transcript;
      if(e.results[i].isFinal) finalTranscript+=t+' ';
      else interimTranscript+=t;
    }
    document.getElementById('liveTxt').textContent=
      (finalTranscript+interimTranscript).trim()||'Speak now ‚Äî listening for your voice‚Ä¶';
  };

  recog.onerror=e=>{
    // 'no-speech' and 'aborted' are normal when we stop ‚Äî ignore them
    if(e.error!=='no-speech'&&e.error!=='aborted')console.warn('Recognition error:',e.error);
  };

  recog.onend=()=>{
    if(listening){
      // Browser stopped automatically (silence timeout) ‚Äî restart immediately
      setTimeout(()=>{try{recog.start();}catch{}},80);
    } else {
      // We stopped intentionally ‚Äî signal that recognition has fully ended
      if(recogEndedResolve){recogEndedResolve();recogEndedResolve=null;}
    }
  };
}

async function initAudio(){
  if(audioStream)return true;
  try{
    audioStream=await navigator.mediaDevices.getUserMedia({audio:{channelCount:1,sampleRate:16000,echoCancellation:true,noiseSuppression:true}});
    return true;
  }catch{setSt('Microphone permission denied');return false;}
}

async function startVoice(){
  if(!recog||listening||busy)return;
  const ok=await initAudio();
  if(!ok)return;
  audioChunks=[];
  const mime=['audio/webm;codecs=opus','audio/webm','audio/ogg;codecs=opus',''].find(m=>!m||MediaRecorder.isTypeSupported(m));
  try{
    mediaRecorder=new MediaRecorder(audioStream,mime?{mimeType:mime}:{});
    mediaRecorder.ondataavailable=e=>{if(e.data?.size>0)audioChunks.push(e.data);};
    mediaRecorder.start(80);
  }catch(e){console.warn('MediaRecorder failed:',e);}
  finalTranscript='';interimTranscript='';
  listening=true;
  document.getElementById('micbtn').classList.add('rec');
  document.getElementById('ibox').classList.add('rec');
  document.getElementById('vov').classList.add('show');
  document.getElementById('liveTxt').textContent='Speak now ‚Äî listening for your voice‚Ä¶';
  setSt('üî¥ Listening‚Ä¶');
  try{recog.start();}catch{}
}

async function stopVoice(){
  if(!listening)return;
  listening=false;spHeld=false;
  document.getElementById('micbtn').classList.remove('rec');
  document.getElementById('ibox').classList.remove('rec');
  document.getElementById('vov').classList.remove('show');

  // STEP 1: Wait for recognition to fully end so we capture the last words.
  // We set listening=false first so onend resolves instead of restarting.
  const recogDone=new Promise(res=>{recogEndedResolve=res;setTimeout(res,600);});
  try{recog.stop();}catch{}
  await recogDone;

  // STEP 2: Merge final + any remaining interim transcript
  // (interim captures words that were mid-utterance when we stopped)
  const txt=(finalTranscript+interimTranscript).trim();
  finalTranscript='';interimTranscript='';

  // STEP 3: Collect audio bytes in parallel (for depression analysis)
  const b64=await new Promise(res=>{
    if(!mediaRecorder||mediaRecorder.state==='inactive'){res('');return;}
    mediaRecorder.onstop=async()=>{
      try{
        const blob=new Blob(audioChunks,{type:mediaRecorder.mimeType||'audio/webm'});
        if(blob.size<800){res('');return;}
        const buf=await blob.arrayBuffer();
        const bytes=new Uint8Array(buf);
        const CHUNK=8192;let bin='';
        for(let i=0;i<bytes.length;i+=CHUNK)bin+=String.fromCharCode(...bytes.subarray(i,i+CHUNK));
        res(btoa(bin));
      }catch{res('');}
    };
    try{mediaRecorder.stop();}catch{res('');}
  });

  if(!txt){setSt('No speech detected ‚Äî please try speaking again');setTimeout(()=>setSt('\u00A0'),3000);return;}
  setSt('\u00A0');
  await sendVoice(txt,b64);
}

async function sendVoice(txt,audioB64){
  if(!tok||!cur||busy)return;
  setBusy(true);addMsg('user',txt,true);showTyp();
  try{
    // KEY CHANGE: send transcript directly ‚Äî backend uses it immediately,
    // audio bytes are only used for depression analysis (runs async)
    const d=await api('POST','/voice/chat',{
      conversation_id:cur.id,
      transcript:txt,        // ‚Üê instant, no Whisper needed
      audio_data:audioB64||''  // ‚Üê only for voice analysis
    });
    hideTyp();
    if(d.response)addMsg('assistant',d.response,true);
    speak(d.response);
    if(d.voice_analysis)showBadge(d.voice_analysis);
  }catch(e){
    hideTyp();addMsg('assistant','‚ö†Ô∏è '+e.message,false);
  }finally{setBusy(false);}
}

function togMic(){listening?stopVoice():startVoice();}

function setupSpc(){
  document.addEventListener('keydown',e=>{
    if(document.getElementById('chat').style.display==='none')return;
    const t=document.activeElement?.tagName;if(t==='INPUT'||t==='TEXTAREA')return;
    if(e.code!=='Space'||spHeld)return;e.preventDefault();spHeld=true;startVoice();
  });
  document.addEventListener('keyup',e=>{
    if(e.code!=='Space'||!spHeld)return;e.preventDefault();stopVoice();
  });
}

// TTS
function togTTS(){ttsOn=!ttsOn;const b=document.getElementById('ttsbtn');b.textContent=ttsOn?'üîä Voice ON':'üîá Voice OFF';b.classList.toggle('on',ttsOn);}
function speak(t){if(!ttsOn||!t)return;window.speechSynthesis.cancel();const u=new SpeechSynthesisUtterance(t);u.rate=.92;u.pitch=1;const vs=window.speechSynthesis.getVoices();const v=vs.find(v=>/samantha|zira|female/i.test(v.name));if(v)u.voice=v;window.speechSynthesis.speak(u);}
window.speechSynthesis.onvoiceschanged=()=>window.speechSynthesis.getVoices();

// VOICE BADGE
function showBadge(a){const ic={High:'üî¥',Moderate:'üü°',Low:'üü¢'};const b=document.getElementById('vbadge');b.style.background=a.badge_color||'#6b7280';b.style.display='block';document.getElementById('vbc').innerHTML=`<strong>${ic[a.risk_level]||''} Voice Analysis</strong><br>Risk: ${a.risk_level} ¬∑ Prob: ${a.probability}%<br>Confidence: ${a.confidence}%`;clearTimeout(b._t);b._t=setTimeout(()=>b.style.display='none',9000);}

// PHQ-8
async function showPHQ8(){if(!tok){alert('Please login first');return;}try{phqD=await api('GET','/phq8/questions');phqR={};renderPHQ();show('phq8');}catch(e){alert('Failed to load PHQ-8: '+e.message);}}
function renderPHQ(){
  document.getElementById('pinst').textContent=phqD.instructions;
  const c=document.getElementById('pqs');c.innerHTML='';
  phqD.questions.forEach((q,i)=>{
    const d=document.createElement('div');d.className='qcard';d.id='qc_'+q.field;
    d.innerHTML=`<div class="qnum">Question ${i+1} of ${phqD.questions.length}</div><div class="qtxt">${esc(q.question)}</div><div class="qopts">${phqD.options.map(o=>`<button class="qopt" onclick="selQ('${q.field}',${o.value},this)">${esc(o.label)}</button>`).join('')}</div>`;
    c.appendChild(d);
  });
}
function selQ(f,v,btn){phqR[f]=v;const c=document.getElementById('qc_'+f);c.querySelectorAll('.qopt').forEach(b=>b.classList.remove('sel'));btn.classList.add('sel');c.classList.add('ans');document.getElementById('psbtn').disabled=!phqD.questions.every(q=>phqR.hasOwnProperty(q.field));}

async function subPHQ(){
  const btn=document.getElementById('psbtn');btn.disabled=true;btn.textContent='Submitting‚Ä¶';
  try{
    const url='/phq8/submit'+(cur?`?conversation_id=${cur.id}`:'');
    const r=await api('POST',url,phqR);

    // ‚îÄ‚îÄ OPTIMIZED: server returns immediately; LLM response comes async ‚îÄ‚îÄ
    await loadConvs();
    const c=convs.find(x=>x.id===r.conversation_id);
    if(c)selConv(c);

    // Show score toast right away
    showTst(r);

    // Show the initial assessment messages that are already in the DB
    await loadMsgs(r.conversation_id);

    // Start polling for the background therapeutic response
    startPhqPoll(r.conversation_id);

    phqR={};
  }catch(e){alert('Failed: '+e.message);}
  finally{btn.disabled=false;btn.textContent='Submit Assessment';}
}

// ‚îÄ‚îÄ PHQ-8 background polling ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// The therapeutic LLM response is generated in the background on the server.
// We poll the conversation messages every 2 s until the count increases.
function startPhqPoll(convId){
  stopPhqPoll();
  phqPollConvId=convId;
  // Count current messages so we know when new ones arrive
  const msgs=document.getElementById('msgs').querySelectorAll('.mrow');
  phqPollMsgCount=msgs.length;
  showPending();
  phqPollTimer=setInterval(()=>pollPhqMsgs(),2000);
  // Safety stop after 60 s
  setTimeout(stopPhqPoll,60000);
}

async function pollPhqMsgs(){
  if(!phqPollConvId)return;
  try{
    const ms=await api('GET',`/conversations/${phqPollConvId}/messages`);
    if(ms.length>phqPollMsgCount){
      // New messages arrived ‚Äî reload the view
      hidePending();stopPhqPoll();
      clrMsgs();
      ms.forEach(m=>addMsg(m.role,m.content,false));
      scrlB();
      // Speak the last assistant message
      const last=[...ms].reverse().find(m=>m.role==='assistant');
      if(last)speak(last.content);
    }
  }catch(e){console.warn('Poll error:',e);stopPhqPoll();}
}

function stopPhqPoll(){
  if(phqPollTimer){clearInterval(phqPollTimer);phqPollTimer=null;}
  phqPollConvId=null;
  hidePending();
}

// TOAST
const SC={'None/Minimal':'#34d399','Mild':'#86efac','Moderate':'#fbbf24','Moderately Severe':'#fb923c','Severe':'#f87171'};
function showTst(r){const col=SC[r.severity]||'var(--tx2)';document.getElementById('tsc').textContent=r.score;document.getElementById('tsc').style.color=col;document.getElementById('tsv').textContent=r.severity;document.getElementById('tsv').style.color=col;document.getElementById('tsb').textContent=r.depressed?'Depression indicators present':'No depression indicators';document.getElementById('toast').style.display='block';clearTimeout(ttmr);ttmr=setTimeout(closeTst,9000);}
function closeTst(){document.getElementById('toast').style.display='none';clearTimeout(ttmr);}

// HISTORY
async function showHist(){if(!tok){alert('Please login first');return;}show('hist');const l=document.getElementById('hlist');l.innerHTML='<p style="color:var(--tx3)">Loading‚Ä¶</p>';
try{const d=await api('GET','/phq8/history');if(!d.length){l.innerHTML='<p style="color:var(--tx3)">No assessments yet.</p>';return;}l.innerHTML=d.map(it=>{const col=SC[it.severity]||'var(--tx2)';const dt=it.date?new Date(it.date).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'';return`<div class="hitem"><div><div class="hsco" style="color:${col}">${it.score}</div><div class="hof">/ 24</div></div><div style="flex:1"><div class="hsev" style="color:${col}">${esc(it.severity)}</div><div class="hdt">${dt}</div></div><div class="sdot" style="background:${col}"></div></div>`;}).join('');}
catch(e){l.innerHTML=`<p style="color:var(--re)">${e.message}</p>`;}}

// HELPERS
function setBusy(v){busy=v;document.getElementById('sndbtn').disabled=v;document.getElementById('micbtn').disabled=v;}
function setSt(m){const e=document.getElementById('stl');e.textContent=m||'\u00A0';e.classList.toggle('on',!!m&&m.trim()!=='\u00A0');}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/\n/g,'<br>');}
</script>
</body>
</html>
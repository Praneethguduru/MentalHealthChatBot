<!DOCTYPE html>
<html>
<head>
<title>Mental Health Chatbot</title>
<style>
* { box-sizing: border-box; }
body {
  font-family: Arial, sans-serif;
  max-width: 960px;
  margin: 30px auto;
  display: flex;
  gap: 15px;
  padding: 0 10px;
}
.sidebar {
  width: 250px;
  border-right: 1px solid #ccc;
  padding-right: 10px;
  flex-shrink: 0;
}
.chat-btn {
  padding: 8px;
  margin-bottom: 6px;
  cursor: pointer;
  background: #f4f4f4;
  border-radius: 4px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 5px;
}
.chat-btn.active { background: #dbeafe; font-weight: bold; }
.chat-btn:hover { background: #e5e7eb; }
.chat-btn.active:hover { background: #bfdbfe; }
.chat-title {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  cursor: pointer;
}
.chat-actions { display: flex; gap: 3px; flex-shrink: 0; }
.icon-btn {
  background: none; border: none; cursor: pointer;
  padding: 4px 6px; font-size: 16px; color: #6b7280;
  line-height: 1; min-width: 24px;
  display: inline-flex; align-items: center; justify-content: center;
}
.icon-btn:hover { color: #1f2937; background: rgba(0,0,0,0.05); border-radius: 4px; }
.delete-btn:hover { color: #dc2626; }
.main { flex: 1; min-width: 0; }

input, button {
  margin: 4px 0; padding: 8px;
  width: 100%; box-sizing: border-box;
}
button {
  cursor: pointer; background: #3b82f6;
  color: white; border: none; border-radius: 4px;
}
button:hover { background: #2563eb; }

#out {
  background: #f9f9f9; padding: 12px;
  height: 360px; overflow-y: auto;
  white-space: pre-wrap; border-radius: 4px;
  margin-bottom: 8px; border: 1px solid #e5e7eb;
}
.message { margin-bottom: 14px; line-height: 1.5; }
.user-msg { color: #1e40af; }
.assistant-msg { color: #059669; }

.send-row { display: flex; gap: 8px; align-items: center; }
.send-row input { flex: 1; margin: 0; }
.send-row button { width: auto; white-space: nowrap; margin: 0; padding: 8px 16px; }

.phq8-container { background: #f0f9ff; padding: 15px; border-radius: 8px; margin-top: 20px; }
.question-block { margin-bottom: 20px; padding: 10px; background: white; border-radius: 4px; }
.option-label { display: block; margin: 5px 0; padding: 5px; cursor: pointer; }
.option-label:hover { background: #e0f2fe; border-radius: 4px; }
.result-box  { background: #dcfce7; padding: 15px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #22c55e; }
.warning-box { background: #fef3c7; padding: 15px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #f59e0b; }
.danger-box  { background: #fee2e2; padding: 15px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #ef4444; }

.modal {
  display: none; position: fixed; z-index: 1000;
  left: 0; top: 0; width: 100%; height: 100%;
  background-color: rgba(0,0,0,0.5);
}
.modal-content {
  background-color: white; margin: 15% auto;
  padding: 20px; border-radius: 8px; width: 80%; max-width: 400px;
}
.modal-buttons { display: flex; gap: 10px; margin-top: 15px; }
.modal-buttons button { flex: 1; }

.voice-instruction {
  background: #fef3c7; padding: 8px; border-radius: 4px;
  text-align: center; font-size: 13px; color: #92400e; margin-bottom: 8px;
}
.voice-controls { display: flex; gap: 8px; margin-bottom: 6px; align-items: center; flex-wrap: wrap; }
.tts-toggle { width: auto; min-width: 130px; padding: 8px 12px; margin: 0; }
.voice-status {
  display: none; text-align: center; padding: 7px 10px;
  background: #f0f9ff; border-radius: 4px; margin-bottom: 6px;
  font-size: 13px; color: #1e40af; font-weight: bold;
}

@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
.rec-dot {
  display: inline-block; width: 10px; height: 10px;
  background: #ef4444; border-radius: 50%;
  animation: pulse 1s infinite; margin-right: 4px;
  vertical-align: middle;
}
#recordingIndicator {
  display: none; font-size: 13px; color: #ef4444;
  font-weight: bold; align-items: center;
}

@keyframes slideUp { from{transform:translateY(20px);opacity:0} to{transform:translateY(0);opacity:1} }
.voice-badge {
  position: fixed; bottom: 24px; right: 24px;
  color: white; padding: 12px 16px; border-radius: 10px;
  font-size: 13px; font-weight: bold; line-height: 1.7;
  box-shadow: 0 4px 16px rgba(0,0,0,0.25);
  z-index: 9999; cursor: pointer; min-width: 190px;
  animation: slideUp 0.3s ease;
}
.badge-close { float: right; font-size: 16px; margin-left: 8px; opacity: 0.8; }
.badge-close:hover { opacity: 1; }
</style>
</head>
<body>

<!-- ============ SIDEBAR ============ -->
<div class="sidebar">
  <button onclick="newConversation()">+ New Conversation</button>
  <div id="chatList"></div>
  <hr>
  <button onclick="startPHQ8()" style="background:#10b981;">PHQ-8 Assessment</button>
  <button onclick="viewPHQ8History()" style="background:#8b5cf6; margin-top:4px;">Assessment History</button>
</div>

<!-- ============ MAIN ============ -->
<div class="main">
  <h2 style="margin-top:0;">Mental Health Chatbot</h2>

  <!-- Auth -->
  <div id="authSection">
    <input id="email" placeholder="Email" />
    <input id="password" placeholder="Password" type="password" />
    <button onclick="signup()">Signup</button>
    <button onclick="login()" style="background:#10b981;">Login</button>
  </div>

  <hr>

  <!-- Chat -->
  <div id="chatSection" style="display:none;">
    <div class="voice-instruction">
       <strong>Push-to-Talk:</strong> Hold <kbd>SPACEBAR</kbd> to speak &amp; record - Release to send
    </div>
    <div class="voice-controls">
      <button id="ttsToggle" class="tts-toggle" onclick="toggleTTS()" style="background:#8b5cf6;">
         Voice: ON
      </button>
      <span id="recordingIndicator">
        <span class="rec-dot"></span> Recording...
      </span>
    </div>
    <div id="voiceStatus" class="voice-status"></div>
    <div id="out"></div>
    <div class="send-row">
      <input id="msg" placeholder="Type a message or hold SPACEBAR to speak..." onkeypress="handleEnter(event)" />
      <button onclick="send()">Send</button>
    </div>
  </div>

  <!-- PHQ-8 Form -->
  <div id="phq8Section" style="display:none;">
    <div class="phq8-container">
      <h3>PHQ-8 Depression Screening</h3>
      <p id="phq8Instructions" style="font-style:italic; color:#666;"></p>
      <div id="phq8Questions"></div>
      <button onclick="submitPHQ8()" style="background:#10b981;">Submit Assessment</button>
      <button onclick="cancelPHQ8()" style="background:#6b7280;">Cancel</button>
    </div>
  </div>

  <!-- PHQ-8 Result -->
  <div id="phq8Result"></div>

  <!-- PHQ-8 History -->
  <div id="phq8HistorySection" style="display:none;">
    <div class="phq8-container">
      <h3>Assessment History</h3>
      <div id="phq8HistoryList"></div>
      <button onclick="closeHistory()" style="background:#6b7280;">Close</button>
    </div>
  </div>
</div>

<!-- Rename Modal -->
<div id="renameModal" class="modal">
  <div class="modal-content">
    <h3>Rename Conversation</h3>
    <input id="newTitle" placeholder="Enter new title…" />
    <div class="modal-buttons">
      <button onclick="confirmRename()" style="background:#10b981;">Save</button>
      <button onclick="closeRenameModal()" style="background:#6b7280;">Cancel</button>
    </div>
  </div>
</div>

<!-- Delete Modal -->
<div id="deleteModal" class="modal">
  <div class="modal-content">
    <h3>Delete Conversation?</h3>
    <p>This action cannot be undone. All messages will be permanently deleted.</p>
    <div class="modal-buttons">
      <button onclick="confirmDelete()" style="background:#dc2626;">Delete</button>
      <button onclick="closeDeleteModal()" style="background:#6b7280;">Cancel</button>
    </div>
  </div>
</div>

<script>
// ─────────────────────────────────────────
// STATE
// ─────────────────────────────────────────
let token                = null;
let conversations        = [];
let currentConversation  = null;
let phq8Data             = null;
let phq8Responses        = {};
let conversationToRename = null;
let conversationToDelete = null;

// Voice / TTS
let recognition     = null;
let ttsEnabled      = true;
let isListening     = false;
let isSpeaking      = false;
let spacebarPressed = false;
let hasRecognized   = false;
let lastTranscript  = "";

// Audio recording
let mediaRecorder = null;
let audioChunks   = [];
let audioStream   = null;

const out      = document.getElementById("out");
const chatList = document.getElementById("chatList");

// ─────────────────────────────────────────
// AUDIO RECORDING  (sends to depression model)
// ─────────────────────────────────────────

async function initAudioRecording() {
  try {
    audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    console.log("Microphone ready for depression analysis");
  } catch (e) {
    console.warn("Mic denied - voice analysis disabled:", e.message);
    audioStream = null;
  }
}

function startRecording() {
  if (!audioStream) return;
  audioChunks = [];
  try {
    const mime = MediaRecorder.isTypeSupported("audio/webm;codecs=opus")
      ? "audio/webm;codecs=opus"
      : MediaRecorder.isTypeSupported("audio/webm") ? "audio/webm" : "";
    mediaRecorder = new MediaRecorder(audioStream, mime ? { mimeType: mime } : {});
    mediaRecorder.ondataavailable = (e) => {
      if (e.data && e.data.size > 0) audioChunks.push(e.data);
    };
    mediaRecorder.start(100);
    document.getElementById("recordingIndicator").style.display = "inline-flex";
  } catch (e) {
    console.warn("MediaRecorder error:", e);
    mediaRecorder = null;
  }
}

function stopRecording() {
  document.getElementById("recordingIndicator").style.display = "none";
  if (!mediaRecorder || mediaRecorder.state === "inactive") return Promise.resolve(null);
  return new Promise((resolve) => {
    mediaRecorder.onstop = async () => {
      try {
        const blob = new Blob(audioChunks, { type: mediaRecorder.mimeType || "audio/webm" });
        if (blob.size < 500) { resolve(null); return; }
        const buf    = await blob.arrayBuffer();
        const bytes  = new Uint8Array(buf);
        let binary   = "";
        bytes.forEach(b => (binary += String.fromCharCode(b)));
        resolve(btoa(binary));
      } catch (e) {
        console.warn("Audio encode error:", e);
        resolve(null);
      }
    };
    mediaRecorder.stop();
  });
}

// ─────────────────────────────────────────
// SPEECH RECOGNITION  (speech → text)
// ─────────────────────────────────────────

function initVoiceRecognition() {
  if (!("webkitSpeechRecognition" in window || "SpeechRecognition" in window)) {
    console.warn("Speech recognition not supported.");
    return;
  }
  const SR    = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SR();
  recognition.continuous      = true;
  recognition.interimResults  = true;
  recognition.lang            = "en-US";
  recognition.maxAlternatives = 1;

  recognition.onstart  = () => { isListening = true; hasRecognized = false; showVoiceStatus("Listening... speak now"); };
  recognition.onresult = (event) => {
  let finalTranscript = "";

  for (let i = event.resultIndex; i < event.results.length; i++) {
    if (event.results[i].isFinal) {
      finalTranscript += event.results[i][0].transcript + " ";
    }
  }

  if (finalTranscript.trim()) {
    lastTranscript = finalTranscript.trim();
    document.getElementById("msg").value = lastTranscript;
    showVoiceStatus(`You said: "${lastTranscript}"`);
  }
};

  recognition.onerror  = (event) => {
    if (event.error === "no-speech") showVoiceStatus("No speech detected. Try again.");
    else if (event.error !== "aborted") showVoiceStatus(`Error: ${event.error}`);
    else hideVoiceStatus();
    isListening = false;
  };
  recognition.onend = () => { isListening = false; };
}

function startVoiceInput() {
  if (!recognition) initVoiceRecognition();
  if (recognition && !isListening) {
    hasRecognized = false; lastTranscript = "";
    try { recognition.start(); } catch (_) {}
  }
}

function stopVoiceInput() {
  if (recognition && isListening) {
    try { recognition.stop(); } catch (_) {}
    isListening = false;
  }
}

// ─────────────────────────────────────────
// SPACEBAR PUSH-TO-TALK
// ─────────────────────────────────────────

document.addEventListener("keydown", (e) => {
  if (document.getElementById("chatSection").style.display === "none") return;
  if (document.activeElement.tagName === "INPUT") return;
  if (e.target.id === "msg") return;
  if (e.code !== "Space" || spacebarPressed) return;
  e.preventDefault();
  spacebarPressed = true;
  startRecording();
  startVoiceInput();
});

document.addEventListener("keyup", async (e) => {
  if (e.code !== "Space" || !spacebarPressed) return;
  e.preventDefault();
  spacebarPressed = false;

  setTimeout(() => stopVoiceInput(), 1200);
  const base64Audio = await stopRecording();

  // Wait briefly for speech recognition result
  await new Promise(r => setTimeout(r, 600));

  const transcript = lastTranscript || document.getElementById("msg").value.trim();
  if (!transcript) { hideVoiceStatus(); return; }

  document.getElementById("msg").value = "";

  if (base64Audio) {
    await sendVoiceMessage(base64Audio, transcript);
  } else {
    await sendTextMessage(transcript);
  }
});

// ─────────────────────────────────────────
// TTS
// ─────────────────────────────────────────

function toggleTTS() {
  ttsEnabled = !ttsEnabled;
  const btn = document.getElementById("ttsToggle");
  btn.innerHTML  = ttsEnabled ? "Voice: ON" : "Voice: OFF";
  btn.style.background = ttsEnabled ? "#8b5cf6" : "#6b7280";
}

function speakText(text) {
  if (!ttsEnabled || isSpeaking) return;
  window.speechSynthesis.cancel();
  const utt    = new SpeechSynthesisUtterance(text);
  const voices = window.speechSynthesis.getVoices();
  const female = voices.find(v =>
    v.name.toLowerCase().includes("female") ||
    v.name.toLowerCase().includes("samantha") ||
    v.name.toLowerCase().includes("zira")
  );
  if (female) utt.voice = female;
  utt.rate = 0.9; utt.pitch = 1.0; utt.volume = 1.0;
  utt.onstart = () => { isSpeaking = true;  showVoiceStatus("Speaking..."); };
  utt.onend   = () => { isSpeaking = false; hideVoiceStatus(); };
  utt.onerror = () => { isSpeaking = false; hideVoiceStatus(); };
  window.speechSynthesis.speak(utt);
}

if (window.speechSynthesis.onvoiceschanged !== undefined) {
  window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
}

// ─────────────────────────────────────────
// VOICE STATUS BAR
// ─────────────────────────────────────────

function showVoiceStatus(msg) {
  const el = document.getElementById("voiceStatus");
  el.innerText = msg;
  el.style.display = "block";
}

function hideVoiceStatus() {
  setTimeout(() => {
    if (!isListening && !isSpeaking)
      document.getElementById("voiceStatus").style.display = "none";
  }, 2000);
}

// ─────────────────────────────────────────
// VOICE ANALYSIS BADGE
// ─────────────────────────────────────────

function showVoiceAnalysisBadge(analysis) {
  const existing = document.getElementById("voiceBadge");
  if (existing) existing.remove();

  const colors = { High: "#ef4444", Moderate: "#f59e0b", Low: "#10b981" };
  const icons  = { High: "RED", Moderate: "YELLOW", Low: "GREEN" };
  const risk   = analysis.risk_level || "Low";

  const badge = document.createElement("div");
  badge.id        = "voiceBadge";
  badge.className = "voice-badge";
  badge.style.background = analysis.badge_color || colors[risk] || "#6b7280";
  badge.innerHTML = `
    <span class="badge-close" onclick="this.parentElement.remove()">✕</span>
    ${icons[risk] || ""} <strong>Voice Analysis</strong><br>
    Risk Level: ${risk}<br>
    Probability: ${analysis.probability}%<br>
    Confidence: ${analysis.confidence}%
  `;
  document.body.appendChild(badge);
  setTimeout(() => { if (badge.parentNode) badge.remove(); }, 9000);
}

// ─────────────────────────────────────────
// SEND — VOICE  (audio + depression analysis)
// ─────────────────────────────────────────

async function sendVoiceMessage(base64Audio, transcript) {
  if (!token || !currentConversation || !transcript) return;

  currentConversation.messages.push({ role: "You", text: transcript });
  renderChat();
  showVoiceStatus("Analyzing voice & generating response…");

  try {
    const res = await fetch("http://127.0.0.1:8000/voice/chat", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify({
        audio_data:      base64Audio,
        conversation_id: currentConversation.id,
        transcript:      transcript
      })
    });

    if (!res.ok) throw new Error("Voice chat failed");
    const data = await res.json();

    currentConversation.messages.push({ role: "BOT", text: data.response });
    renderChat();
    hideVoiceStatus();

    if (ttsEnabled) speakText(data.response);
    if (data.voice_analysis) showVoiceAnalysisBadge(data.voice_analysis);

  } catch (err) {
    console.error("Voice send error - falling back to text:", err);
    hideVoiceStatus();
    currentConversation.messages.pop();
    renderChat();
    await sendTextMessage(transcript);
  }
}

// ─────────────────────────────────────────
// SEND — TEXT ONLY
// ─────────────────────────────────────────

async function sendTextMessage(message) {
  if (!token || !currentConversation || !message.trim()) return;

  currentConversation.messages.push({ role: "You", text: message });
  renderChat();

  try {
    const res = await fetch(`http://127.0.0.1:8000/chat/${currentConversation.id}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify({ message })
    });
    if (!res.ok) throw new Error("Chat failed");
    const data = await res.json();
    currentConversation.messages.push({ role: "BOT", text: data.response });
    renderChat();
    if (ttsEnabled) speakText(data.response);
  } catch (err) {
    console.error("Send error:", err);
    currentConversation.messages.pop();
    renderChat();
    alert("Failed to send message. Please try again.");
  }
}

// ─────────────────────────────────────────
// SEND — button / Enter key
// ─────────────────────────────────────────

async function send() {
  if (!token || !currentConversation) { alert("Login first"); return; }
  const msgInput = document.getElementById("msg");
  const message  = msgInput.value.trim();
  if (!message) return;
  msgInput.value = "";
  await sendTextMessage(message);
}

function handleEnter(e) { if (e.key === "Enter") send(); }

// ─────────────────────────────────────────
// SIDEBAR
// ─────────────────────────────────────────

function renderSidebar() {
  chatList.innerHTML = "";
  conversations.forEach(c => {
    const div = document.createElement("div");
    div.className = "chat-btn" + (currentConversation && currentConversation.id === c.id ? " active" : "");

    const titleSpan     = document.createElement("span");
    titleSpan.className = "chat-title";
    titleSpan.innerText = c.title;
    titleSpan.onclick   = (e) => { e.stopPropagation(); selectConversation(c); };

    const actionsDiv     = document.createElement("div");
    actionsDiv.className = "chat-actions";

    const renameBtn     = document.createElement("button");
    renameBtn.className = "icon-btn";
    renameBtn.innerHTML = "Rename"; renameBtn.title = "Rename";
    renameBtn.onclick   = (e) => { e.stopPropagation(); openRenameModal(c); };

    const deleteBtn     = document.createElement("button");
    deleteBtn.className = "icon-btn delete-btn";
    deleteBtn.innerHTML = "Delete"; deleteBtn.title = "Delete";
    deleteBtn.onclick   = (e) => { e.stopPropagation(); openDeleteModal(c); };

    actionsDiv.appendChild(renameBtn);
    actionsDiv.appendChild(deleteBtn);
    div.appendChild(titleSpan);
    div.appendChild(actionsDiv);
    chatList.appendChild(div);
  });
}

function selectConversation(c) {
  currentConversation = c;
  showChatSection();
  loadMessages(c.id);
  renderSidebar();
}

async function loadMessages(conversationId) {
  try {
    const res = await fetch(`http://127.0.0.1:8000/conversations/${conversationId}/messages`, {
      headers: { "Authorization": "Bearer " + token }
    });
    if (res.ok) {
      const msgs = await res.json();
      currentConversation.messages = msgs.map(m => ({
        role: m.role === "user" ? "You" : "BOT",
        text: m.content
      }));
    } else {
      currentConversation.messages = [];
    }
    renderChat();
    setTimeout(() => { out.scrollTop = out.scrollHeight; }, 100);
  } catch (err) {
    console.error("Load messages error:", err);
    currentConversation.messages = [];
    renderChat();
  }
}

function renderChat() {
  out.innerHTML = "";
  if (!currentConversation) return;
  currentConversation.messages.forEach(m => {
    const cls = m.role === "You" ? "user-msg" : "assistant-msg";
    out.innerHTML += `<div class="message ${cls}"><b>${m.role}:</b> ${m.text}</div>`;
  });
  out.scrollTop = out.scrollHeight;
}

function showChatSection() {
  document.getElementById("chatSection").style.display       = "block";
  document.getElementById("phq8Section").style.display       = "none";
  document.getElementById("phq8Result").innerHTML             = "";
  document.getElementById("phq8HistorySection").style.display = "none";
}

// ─────────────────────────────────────────
// RENAME
// ─────────────────────────────────────────

function openRenameModal(c) {
  conversationToRename = c;
  document.getElementById("newTitle").value = c.title;
  document.getElementById("renameModal").style.display = "block";
}
function closeRenameModal() {
  conversationToRename = null;
  document.getElementById("renameModal").style.display = "none";
}
async function confirmRename() {
  const newTitle = document.getElementById("newTitle").value.trim();
  if (!newTitle) { alert("Please enter a title"); return; }
  try {
    const res = await fetch(`http://127.0.0.1:8000/conversations/${conversationToRename.id}/title`, {
      method: "PUT",
      headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
      body: JSON.stringify({ title: newTitle })
    });
    if (!res.ok) throw new Error();
    conversationToRename.title = newTitle;
    renderSidebar();
    closeRenameModal();
  } catch { alert("Failed to rename conversation"); }
}

// ─────────────────────────────────────────
// DELETE
// ─────────────────────────────────────────

function openDeleteModal(c) {
  conversationToDelete = c;
  document.getElementById("deleteModal").style.display = "block";
}
function closeDeleteModal() {
  conversationToDelete = null;
  document.getElementById("deleteModal").style.display = "none";
}
async function confirmDelete() {
  try {
    const res = await fetch(`http://127.0.0.1:8000/conversations/${conversationToDelete.id}`, {
      method: "DELETE",
      headers: { "Authorization": "Bearer " + token }
    });
    if (!res.ok) throw new Error();
    conversations = conversations.filter(c => c.id !== conversationToDelete.id);
    if (currentConversation && currentConversation.id === conversationToDelete.id) {
      currentConversation = null;
      out.innerHTML = "";
    }
    renderSidebar();
    closeDeleteModal();
    if (conversations.length === 0) await newConversation();
    else if (!currentConversation) selectConversation(conversations[0]);
  } catch { alert("Failed to delete conversation"); }
}

// ─────────────────────────────────────────
// CONVERSATIONS
// ─────────────────────────────────────────

async function newConversation() {
  if (!token) { alert("Please login first"); return; }
  try {
    const res = await fetch("http://127.0.0.1:8000/conversations", {
      method: "POST",
      headers: { "Authorization": "Bearer " + token }
    });
    if (!res.ok) throw new Error();
    const data  = await res.json();
    const convo = { id: data.conversation_id, title: "New Conversation", messages: [] };
    conversations.unshift(convo);
    currentConversation = convo;
    showChatSection();
    renderSidebar();
    renderChat();
  } catch { alert("Failed to create conversation. Please try again."); }
}

async function loadConversations() {
  if (!token) return;
  try {
    const res = await fetch("http://127.0.0.1:8000/conversations", {
      headers: { "Authorization": "Bearer " + token }
    });
    if (!res.ok) throw new Error();
    const data = await res.json();
    conversations = data.map(c => ({ id: c.id, title: c.title, messages: [] }));
    renderSidebar();
    if (conversations.length > 0) selectConversation(conversations[0]);
    else await newConversation();
  } catch (err) { console.error("Load conversations error:", err); }
}

// ─────────────────────────────────────────
// AUTH
// ─────────────────────────────────────────

async function signup() {
  try {
    const res = await fetch("http://127.0.0.1:8000/signup", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email: email.value, password: password.value })
    });
    if (!res.ok) { const e = await res.json(); throw new Error(e.detail || "Signup failed"); }
    alert("Signup successful. Please login.");
  } catch (e) { alert(e.message); }
}

async function login() {
  try {
    const res = await fetch("http://127.0.0.1:8000/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email: email.value, password: password.value })
    });
    if (!res.ok) { const e = await res.json(); throw new Error(e.detail || "Login failed"); }

    const data = await res.json();
    token = data.access_token;
    document.getElementById("authSection").style.display = "none";

    // Init microphone and speech recognition AFTER login
    await initAudioRecording();
    initVoiceRecognition();

    await loadConversations();
  } catch (e) { alert(e.message); }
}

// ─────────────────────────────────────────
// PHQ-8
// ─────────────────────────────────────────

async function startPHQ8() {
  if (!token) { alert("Please login first"); return; }
  try {
    const res = await fetch("http://127.0.0.1:8000/phq8/questions", {
      headers: { "Authorization": "Bearer " + token }
    });
    if (!res.ok) throw new Error();
    phq8Data = await res.json();
    phq8Responses = {};
    renderPHQ8();
  } catch { alert("Failed to load assessment. Please try again."); }
}

function renderPHQ8() {
  document.getElementById("chatSection").style.display       = "none";
  document.getElementById("phq8Section").style.display       = "block";
  document.getElementById("phq8Result").innerHTML             = "";
  document.getElementById("phq8HistorySection").style.display = "none";
  document.getElementById("phq8Instructions").innerText       = phq8Data.instructions;

  const container = document.getElementById("phq8Questions");
  container.innerHTML = "";

  phq8Data.questions.forEach((q, index) => {
    const div = document.createElement("div");
    div.className = "question-block";
    let optionsHTML = "";
    phq8Data.options.forEach(opt => {
      optionsHTML += `
        <label class="option-label">
          <input type="radio" name="${q.field}" value="${opt.value}"
                 onchange="updatePHQ8('${q.field}', ${opt.value})">
          ${opt.label}
        </label>`;
    });
    div.innerHTML = `<p><strong>${index + 1}. ${q.question}</strong></p>${optionsHTML}`;
    container.appendChild(div);
  });
}

function updatePHQ8(field, value) { phq8Responses[field] = value; }

async function submitPHQ8() {
  const allAnswered = phq8Data.questions.every(q => phq8Responses.hasOwnProperty(q.field));
  if (!allAnswered) { alert("Please answer all 8 questions before submitting"); return; }

  try {
    const url = currentConversation
      ? `http://127.0.0.1:8000/phq8/submit?conversation_id=${currentConversation.id}`
      : "http://127.0.0.1:8000/phq8/submit";

    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
      body: JSON.stringify(phq8Responses)
    });
    if (!res.ok) throw new Error();
    const result = await res.json();

    if (!currentConversation || result.conversation_id !== currentConversation.id) {
      await loadConversations();
      const newConvo = conversations.find(c => c.id === result.conversation_id);
      if (newConvo) {
        currentConversation = newConvo;
        currentConversation.title = "PHQ-8 Assessment";
        renderSidebar();
      }
    }

    await loadMessages(result.conversation_id);
    showChatSection();
    displayPHQ8ResultSummary(result);

    if (ttsEnabled && result.therapeutic_response) {
      setTimeout(() => speakText(result.therapeutic_response), 2000);
    }
  } catch { alert("Failed to submit assessment. Please try again."); }
}

function displayPHQ8ResultSummary(result) {
  let boxClass = "result-box";
  if (result.score >= 15) boxClass = "danger-box";
  else if (result.score >= 10) boxClass = "warning-box";

  document.getElementById("phq8Result").innerHTML = `
    <div class="${boxClass}">
      <h3>PHQ-8 Assessment Submitted</h3>
      <p><strong>Score:</strong> ${result.score} out of 24</p>
      <p><strong>Severity:</strong> ${result.severity}</p>
      <p style="font-size:14px; margin-top:8px;">
        Your results and a personalised therapeutic response have been added to the conversation.
      </p>
      <button onclick="closePHQ8Result()" style="margin-top:12px;">Continue Conversation</button>
    </div>`;

  phq8Responses = {};
  setTimeout(closePHQ8Result, 8000);
}

function closePHQ8Result() { document.getElementById("phq8Result").innerHTML = ""; }
function cancelPHQ8()       { phq8Responses = {}; showChatSection(); }

async function viewPHQ8History() {
  if (!token) { alert("Please login first"); return; }
  try {
    const res = await fetch("http://127.0.0.1:8000/phq8/history", {
      headers: { "Authorization": "Bearer " + token }
    });
    if (!res.ok) throw new Error();
    displayPHQ8History(await res.json());
  } catch { alert("Failed to load assessment history."); }
}

function displayPHQ8History(history) {
  document.getElementById("chatSection").style.display       = "none";
  document.getElementById("phq8Section").style.display       = "none";
  document.getElementById("phq8Result").innerHTML             = "";
  document.getElementById("phq8HistorySection").style.display = "block";

  const container = document.getElementById("phq8HistoryList");
  if (history.length === 0) {
    container.innerHTML = "<p>No assessments found. Take your first assessment!</p>";
    return;
  }
  container.innerHTML = history.map((item, i) => {
    const date = new Date(item.date).toLocaleDateString();
    let boxClass = "result-box";
    if (item.score >= 15) boxClass = "danger-box";
    else if (item.score >= 10) boxClass = "warning-box";
    return `
      <div class="${boxClass}" style="margin-bottom:12px;">
        <p><strong>Assessment #${history.length - i}</strong> — ${date}</p>
        <p>Score: ${item.score}/24 &nbsp;|&nbsp; Severity: ${item.severity}</p>
      </div>`;
  }).join("");
}

function closeHistory() { showChatSection(); }
</script>
</body>
</html>
